openapi: 3.1.0
info:
  title: physical-mcp Vision API (ChatGPT GPT Action)
  version: 1.1.0
  description: |
    GPT Action wrapper for physical-mcp HTTP Vision API.
    Use this when ChatGPT cannot connect via MCP.
servers:
  - url: https://YOUR-PHYSICAL-MCP-HOST
    description: Replace with your HTTPS endpoint (e.g., Cloudflare tunnel URL)
paths:
  /scene:
    get:
      operationId: getScene
      summary: Get scene summary for all cameras
      responses:
        '200':
          description: Scene summaries keyed by camera ID
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SceneResponse'
              examples:
                default:
                  value:
                    cameras:
                      usb:0:
                        name: Front Door
                        summary: A closed front door and hallway are visible
                        objects_present:
                          - door
                          - doormat
                        people_count: 0
                        last_updated: "2026-02-18T01:23:45.000000"
                        update_count: 42
                    timestamp: 1771377825.52
  /scene/{camera_id}:
    get:
      operationId: getSceneByCamera
      summary: Get scene summary for one camera
      parameters:
        - in: path
          name: camera_id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Scene summary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CameraScene'
              examples:
                person_at_door:
                  value:
                    name: Front Door
                    summary: One person is standing at the front door
                    objects_present:
                      - person
                      - door
                      - package
                    people_count: 1
                    last_updated: "2026-02-18T01:25:01.000000"
                    update_count: 57
        '404':
          description: Camera not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                not_found:
                  value:
                    code: camera_not_found
                    message: Camera 'usb:9' not found
                    camera_id: usb:9
  /changes:
    get:
      operationId: getRecentChanges
      summary: Get recent scene changes (supports long-poll)
      parameters:
        - in: query
          name: minutes
          schema:
            type: integer
            minimum: 1
            maximum: 120
            default: 5
        - in: query
          name: camera_id
          schema:
            type: string
          description: Camera id filter (leading/trailing whitespace is ignored).
        - in: query
          name: wait
          schema:
            type: boolean
            default: false
        - in: query
          name: timeout
          schema:
            type: number
            minimum: 1
            maximum: 120
            default: 30
        - in: query
          name: since
          schema:
            type: string
            format: date-time
          description: Return only changes after this timestamp. Invalid values are ignored (treated as no cursor).
      responses:
        '200':
          description: Recent changes grouped by camera
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChangesResponse'
              examples:
                change_detected:
                  value:
                    changes:
                      usb:0:
                        - timestamp: "2026-02-18T01:24:58.000000"
                          description: major scene change
                      usb:1: []
                    minutes: 5
                timeout:
                  value:
                    changes:
                      usb:0: []
                    minutes: 5
                    timeout: true
                long_poll_timeout_wait_true:
                  value:
                    changes:
                      usb:0: []
                    minutes: 5
                    timeout: true
                invalid_since_ignored_with_camera_filter:
                  value:
                    changes:
                      usb:0:
                        - timestamp: "2026-02-18T01:24:58.000000"
                          description: major scene change
                    minutes: 5
  /frame/{camera_id}:
    get:
      operationId: getFrameByCamera
      summary: Get latest frame as JPEG
      parameters:
        - in: path
          name: camera_id
          required: true
          schema:
            type: string
        - in: query
          name: quality
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 80
      responses:
        '200':
          description: JPEG frame
          content:
            image/jpeg:
              schema:
                type: string
                format: binary
        '404':
          description: Camera not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /health:
    get:
      operationId: getHealthAll
      summary: Get per-camera health snapshots
      responses:
        '200':
          description: Health state for all cameras
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthAllResponse'
              examples:
                default:
                  value:
                    cameras:
                      usb:0:
                        camera_id: usb:0
                        camera_name: Front Door
                        consecutive_errors: 0
                        backoff_until: null
                        last_success_at: "2026-02-18T02:10:45.000000"
                        last_error: ""
                        last_frame_at: "2026-02-18T02:10:46.000000"
                        status: running
                    timestamp: 1771380646.12
  /health/{camera_id}:
    get:
      operationId: getHealthByCamera
      summary: Get per-camera health for one camera
      parameters:
        - in: path
          name: camera_id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Health state for one camera
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthSingleResponse'
              examples:
                degraded:
                  value:
                    camera_id: usb:0
                    health:
                      camera_id: usb:0
                      camera_name: Front Door
                      consecutive_errors: 3
                      backoff_until: "2026-02-18T02:12:30.000000"
                      last_success_at: "2026-02-18T02:11:40.000000"
                      last_error: Provider timeout
                      last_frame_at: "2026-02-18T02:12:00.000000"
                      status: degraded
  /alerts:
    get:
      operationId: replayAlerts
      summary: Replay recent alert events
      description: Returns events in deterministic order (oldest to newest by timestamp, tie-break by event_id).
      parameters:
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 500
            default: 50
        - in: query
          name: since
          schema:
            type: string
            format: date-time
          description: ISO timestamp cursor (exclusive). Invalid values are ignored (treated as no cursor).
        - in: query
          name: camera_id
          schema:
            type: string
          description: Camera id filter (leading/trailing whitespace is ignored; replayed stored camera_id values are normalized too).
        - in: query
          name: event_type
          schema:
            type: string
            enum:
              - watch_rule_triggered
              - camera_alert_pending_eval
              - provider_error
              - rule_eval_error
              - startup_warning
              - system
          description: Event type filter (case-insensitive; replayed stored event_type values are normalized too).
      responses:
        '200':
          description: Recent alert events
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AlertsResponse'
              examples:
                triggered:
                  value:
                    events:
                      - event_id: evt_a1b2c3d4e5
                        event_type: watch_rule_triggered
                        camera_id: usb:0
                        camera_name: Front Door
                        rule_id: r_12ab34cd
                        rule_name: Front Door Watch
                        message: Person detected at door
                        timestamp: "2026-02-18T02:13:02.000000"
                    count: 1
                    timestamp: 1771380782.45
                compound_filter_provider_error:
                  value:
                    events:
                      - event_id: evt_b4c5d6e7f8
                        event_type: provider_error
                        camera_id: usb:0
                        camera_name: Front Door
                        rule_id: ""
                        rule_name: ""
                        message: Vision provider timeout
                        timestamp: "2026-02-18T02:14:10.000000"
                    count: 1
                    timestamp: 1771380850.12
                normalized_query_inputs:
                  value:
                    events:
                      - event_id: evt_c9d0e1f2a3
                        event_type: provider_error
                        camera_id: usb:0
                        camera_name: Front Door
                        rule_id: ""
                        rule_name: ""
                        message: Timeout after 30s
                        timestamp: "2026-02-18T02:15:12.000000"
                    count: 1
                    timestamp: 1771380912.50
                invalid_since_ignored:
                  value:
                    events:
                      - event_id: evt_d4e5f6a7b8
                        event_type: provider_error
                        camera_id: usb:0
                        camera_name: Front Door
                        rule_id: ""
                        rule_name: ""
                        message: Timeout after reconnect
                        timestamp: "2026-02-18T02:16:40.000000"
                    count: 1
                    timestamp: 1771381000.21
                boundary_equal_since_empty:
                  value:
                    events: []
                    count: 0
                    timestamp: 1771381045.70
                normalized_stored_values:
                  value:
                    events:
                      - event_id: evt_e7f8a9b0c1
                        event_type: provider_error
                        camera_id: usb:0
                        camera_name: Front Door
                        rule_id: ""
                        rule_name: ""
                        message: Legacy replay row had space-padded fields
                        timestamp: "2026-02-18T02:18:10.000000"
                    count: 1
                    timestamp: 1771381090.33
                mixed_edge_normalized_limit:
                  value:
                    events:
                      - event_id: evt_f1a2b3c4d5
                        event_type: provider_error
                        camera_id: usb:0
                        camera_name: Front Door
                        rule_id: ""
                        rule_name: ""
                        message: Newest matching replay row after invalid cursor fallback
                        timestamp: "2026-02-18T02:41:00.000000"
                    count: 1
                    timestamp: 1771382460.11
                boundary_exclusive_normalized_limit:
                  value:
                    events:
                      - event_id: evt_g6h7i8j9k0
                        event_type: provider_error
                        camera_id: usb:0
                        camera_name: Front Door
                        rule_id: ""
                        rule_name: ""
                        message: Boundary-equal row excluded; newest later row selected by limit
                        timestamp: "2026-02-18T02:50:00.200000"
                    count: 1
                    timestamp: 1771383000.55
                pending_eval_normalized_limit:
                  value:
                    events:
                      - event_id: evt_h1i2j3k4l5
                        event_type: camera_alert_pending_eval
                        camera_id: usb:0
                        camera_name: Front Door
                        rule_id: ""
                        rule_name: ""
                        message: Major scene change detected; pending LLM/client rule evaluation
                        timestamp: "2026-02-18T03:10:00.200000"
                    count: 1
                    timestamp: 1771384200.22
                malformed_legacy_skipped_by_since:
                  value:
                    events:
                      - event_id: evt_i6j7k8l9m0
                        event_type: provider_error
                        camera_id: usb:0
                        camera_name: Front Door
                        rule_id: ""
                        rule_name: ""
                        message: Valid row after cursor; malformed legacy rows skipped
                        timestamp: "2026-02-18T03:31:00+00:00"
                    count: 1
                    timestamp: 1771385460.90
                boundary_equal_exclusive_mixed_timezone:
                  value:
                    events:
                      - event_id: evt_j1k2l3m4n5
                        event_type: provider_error
                        camera_id: usb:0
                        camera_name: Front Door
                        rule_id: ""
                        rule_name: ""
                        message: Boundary-equal aware/naive rows excluded; only later row returned
                        timestamp: "2026-02-18T03:30:00.100000"
                    count: 1
                    timestamp: 1771385400.30
                invalid_since_mixed_timezone_limit:
                  value:
                    events:
                      - event_id: evt_k6l7m8n9o0
                        event_type: provider_error
                        camera_id: usb:0
                        camera_name: Front Door
                        rule_id: ""
                        rule_name: ""
                        message: Invalid cursor ignored; newest mixed-timezone provider_error selected by limit
                        timestamp: "2026-02-18T03:31:00"
                    count: 1
                    timestamp: 1771385460.95
                malformed_and_valid_compound_limit:
                  value:
                    events:
                      - event_id: evt_lmv_2
                        event_type: provider_error
                        camera_id: usb:0
                        camera_name: Front Door
                        rule_id: ""
                        rule_name: ""
                        message: Compound filters applied; malformed older row retained safely but latest valid row wins with limit=1
                        timestamp: "2026-02-18T03:55:00"
                    count: 1
                    timestamp: 1771386900.40
                valid_since_excludes_malformed_compound_limit:
                  value:
                    events:
                      - event_id: evt_vsm_3
                        event_type: provider_error
                        camera_id: usb:0
                        camera_name: Front Door
                        rule_id: ""
                        rule_name: ""
                        message: Valid cursor excludes malformed rows; latest valid filtered event selected by limit
                        timestamp: "2026-02-18T04:00:00"
                    count: 1
                    timestamp: 1771387200.40
                equivalent_instant_tie_break_by_event_id:
                  value:
                    events:
                      - event_id: evt_eq_1
                        event_type: provider_error
                        camera_id: usb:0
                        camera_name: Front Door
                        rule_id: ""
                        rule_name: ""
                        message: Same UTC instant as next row; lower event_id appears first
                        timestamp: "2026-02-18T04:00:00+00:00"
                      - event_id: evt_eq_2
                        event_type: provider_error
                        camera_id: usb:0
                        camera_name: Front Door
                        rule_id: ""
                        rule_name: ""
                        message: Equivalent instant represented as +08:00 offset
                        timestamp: "2026-02-18T12:00:00+08:00"
                      - event_id: evt_eq_3
                        event_type: provider_error
                        camera_id: usb:0
                        camera_name: Front Door
                        rule_id: ""
                        rule_name: ""
                        message: Later instant
                        timestamp: "2026-02-18T04:00:01+00:00"
                    count: 3
                    timestamp: 1771387201.20
                equivalent_instant_since_limit:
                  value:
                    events:
                      - event_id: evt_eqs_3
                        event_type: provider_error
                        camera_id: usb:0
                        camera_name: Front Door
                        rule_id: ""
                        rule_name: ""
                        message: After equivalent-instant boundary cursor, latest row selected by limit
                        timestamp: "2026-02-18T04:00:02+00:00"
                    count: 1
                    timestamp: 1771387202.20
                event_id_correlation_triage:
                  value:
                    events:
                      - event_id: evt_corr_12345
                        event_type: watch_rule_triggered
                        camera_id: usb:0
                        camera_name: Front Door
                        rule_id: r_12ab34cd
                        rule_name: Front Door Watch
                        message: Person detected at front door
                        timestamp: "2026-02-18T04:10:10.000000"
                    count: 1
                    timestamp: 1771387810.12
                startup_warning_event_id_correlation:
                  summary: Startup fallback warning (initial startup path)
                  description: Startup variant uses message text beginning with "Server is running in fallback..."; correlate event_id with PMCP startup_warning log line. PMCP log data for startup path should reflect the same startup wording. event_type remains "startup_warning" for both startup and runtime-switch variants; use message text to differentiate. Do not expect runtime-switch wording ("Runtime switched to fallback...") in this startup variant.
                  value:
                    events:
                      - event_id: evt_start_100
                        event_type: startup_warning
                        camera_id: ""
                        camera_name: ""
                        rule_id: ""
                        rule_name: ""
                        message: Server is running in fallback client-side reasoning mode
                        timestamp: "2026-02-18T04:12:00.000000"
                    count: 1
                    timestamp: 1771387920.10
                startup_warning_empty_fields_contract:
                  value:
                    events:
                      - event_id: evt_start_101
                        event_type: startup_warning
                        camera_id: ""
                        camera_name: ""
                        rule_id: ""
                        rule_name: ""
                        message: Fallback mode active; configure provider for server-side monitoring
                        timestamp: "2026-02-18T04:12:30.000000"
                    count: 1
                    timestamp: 1771387950.10
                startup_warning_runtime_switch_variant:
                  summary: Runtime provider downgrade warning (server->fallback)
                  description: Correlate this event_id with PMCP startup_warning log line for downgrade triage. PMCP log data for runtime-switch path should reflect runtime-switch wording ("Runtime switched to fallback..."). Do not expect startup wording ("Server is running in fallback...") in this runtime-switch variant.
                  value:
                    events:
                      - event_id: evt_start_202
                        event_type: startup_warning
                        camera_id: ""
                        camera_name: ""
                        rule_id: ""
                        rule_name: ""
                        message: Runtime switched to fallback client-side reasoning mode. Recommended default remains server-side.
                        timestamp: "2026-02-18T20:06:30.000000"
                    count: 1
                    timestamp: 1771445190.10
                event_variant_watch_rule_triggered:
                  value:
                    events:
                      - event_id: evt_wr_101
                        event_type: watch_rule_triggered
                        camera_id: usb:0
                        camera_name: Front Door
                        rule_id: r_12ab34cd
                        rule_name: Front Door Watch
                        message: Person detected at the front door
                        timestamp: "2026-02-18T03:40:00.000000"
                    count: 1
                    timestamp: 1771386000.10
                event_variant_provider_error:
                  value:
                    events:
                      - event_id: evt_pe_101
                        event_type: provider_error
                        camera_id: usb:0
                        camera_name: Front Door
                        rule_id: ""
                        rule_name: ""
                        message: Vision provider timeout (retry in 20s)
                        timestamp: "2026-02-18T03:42:00.000000"
                    count: 1
                    timestamp: 1771386120.10
                event_variant_rule_eval_error:
                  value:
                    events:
                      - event_id: evt_re_101
                        event_type: rule_eval_error
                        camera_id: usb:0
                        camera_name: Front Door
                        rule_id: ""
                        rule_name: ""
                        message: Rule evaluation failed: provider malformed JSON
                        timestamp: "2026-02-18T03:43:00.000000"
                    count: 1
                    timestamp: 1771386180.10
                event_variant_startup_warning:
                  value:
                    events:
                      - event_id: evt_sw_101
                        event_type: startup_warning
                        camera_id: ""
                        camera_name: ""
                        rule_id: ""
                        rule_name: ""
                        message: Server is running in fallback client-side reasoning mode
                        timestamp: "2026-02-18T03:44:00.000000"
                    count: 1
                    timestamp: 1771386240.10
                event_variant_system:
                  value:
                    events:
                      - event_id: evt_sys_101
                        event_type: system
                        camera_id: ""
                        camera_name: ""
                        rule_id: ""
                        rule_name: ""
                        message: Monitoring subsystem initialized
                        timestamp: "2026-02-18T03:45:00.000000"
                    count: 1
                    timestamp: 1771386300.10
components:
  schemas:
    CameraScene:
      type: object
      additionalProperties: true
      properties:
        name:
          type: string
        summary:
          type: string
        objects_present:
          type: array
          items:
            type: string
        people_count:
          type: integer
        last_updated:
          type: string
          format: date-time
        update_count:
          type: integer
      required:
        - summary
        - objects_present
        - people_count
    SceneResponse:
      type: object
      properties:
        cameras:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/CameraScene'
        timestamp:
          type: number
      required:
        - cameras
        - timestamp
    ChangeEvent:
      type: object
      properties:
        timestamp:
          type: string
          format: date-time
        description:
          type: string
      required:
        - timestamp
        - description
    ChangesResponse:
      type: object
      properties:
        changes:
          type: object
          additionalProperties:
            type: array
            items:
              $ref: '#/components/schemas/ChangeEvent'
        minutes:
          type: integer
        timeout:
          type: boolean
      required:
        - changes
        - minutes
    ErrorResponse:
      type: object
      properties:
        code:
          type: string
        message:
          type: string
        camera_id:
          type: string
      required:
        - code
        - message
    CameraHealth:
      type: object
      properties:
        camera_id:
          type: string
        camera_name:
          type: string
        consecutive_errors:
          type: integer
        backoff_until:
          anyOf:
            - type: string
              format: date-time
            - type: "null"
        last_success_at:
          anyOf:
            - type: string
              format: date-time
            - type: "null"
        last_error:
          type: string
        last_frame_at:
          anyOf:
            - type: string
              format: date-time
            - type: "null"
        status:
          type: string
          enum: [starting, running, backoff, degraded, unknown]
    HealthAllResponse:
      type: object
      properties:
        cameras:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/CameraHealth'
        timestamp:
          type: number
      required:
        - cameras
    HealthSingleResponse:
      type: object
      properties:
        camera_id:
          type: string
        health:
          $ref: '#/components/schemas/CameraHealth'
      required:
        - camera_id
        - health
    AlertEventBase:
      type: object
      description: |
        Alert event base schema. Empty strings (not null) are used for optional fields
        when context does not apply â€” e.g., startup_warning has empty camera_id,
        camera_name, rule_id, and rule_name because it is a global fallback-mode warning event
        (emitted at startup and on runtime switches back to fallback mode).
        startup_warning keeps a stable event_type; distinguish startup vs runtime-switch
        variants using the message text and correlate with event_id across PMCP logs/replay.
      properties:
        event_id:
          type: string
        event_type:
          type: string
        camera_id:
          type: string
        camera_name:
          type: string
        rule_id:
          type: string
        rule_name:
          type: string
        message:
          type: string
        timestamp:
          type: string
          format: date-time
      required:
        - event_id
        - event_type
        - timestamp
    WatchRuleTriggeredEvent:
      allOf:
        - $ref: '#/components/schemas/AlertEventBase'
        - type: object
          properties:
            event_type:
              type: string
              enum: [watch_rule_triggered]
            rule_id:
              type: string
              minLength: 1
            rule_name:
              type: string
              minLength: 1
          required:
            - event_type
            - rule_id
            - rule_name
      example:
        event_id: evt_wr_001
        event_type: watch_rule_triggered
        camera_id: usb:0
        camera_name: Front Door
        rule_id: r_12ab34cd
        rule_name: Front Door Watch
        message: Person detected at the front door
        timestamp: "2026-02-18T03:40:00.000000"
    CameraAlertPendingEvalEvent:
      allOf:
        - $ref: '#/components/schemas/AlertEventBase'
        - type: object
          properties:
            event_type:
              type: string
              enum: [camera_alert_pending_eval]
          required:
            - event_type
      example:
        event_id: evt_pe_001
        event_type: camera_alert_pending_eval
        camera_id: usb:0
        camera_name: Front Door
        rule_id: ""
        rule_name: ""
        message: Major scene change detected; pending evaluation
        timestamp: "2026-02-18T03:41:00.000000"
    ProviderErrorEvent:
      allOf:
        - $ref: '#/components/schemas/AlertEventBase'
        - type: object
          properties:
            event_type:
              type: string
              enum: [provider_error]
          required:
            - event_type
      example:
        event_id: evt_pe_101
        event_type: provider_error
        camera_id: usb:0
        camera_name: Front Door
        rule_id: ""
        rule_name: ""
        message: Vision provider timeout (retry in 20s)
        timestamp: "2026-02-18T03:42:00.000000"
    RuleEvalErrorEvent:
      allOf:
        - $ref: '#/components/schemas/AlertEventBase'
        - type: object
          properties:
            event_type:
              type: string
              enum: [rule_eval_error]
          required:
            - event_type
      example:
        event_id: evt_re_001
        event_type: rule_eval_error
        camera_id: usb:0
        camera_name: Front Door
        rule_id: ""
        rule_name: ""
        message: Rule evaluation failed: provider malformed JSON
        timestamp: "2026-02-18T03:43:00.000000"
    StartupWarningEvent:
      allOf:
        - $ref: '#/components/schemas/AlertEventBase'
        - type: object
          properties:
            event_type:
              type: string
              enum: [startup_warning]
          required:
            - event_type
      example:
        event_id: evt_sw_001
        event_type: startup_warning
        camera_id: ""
        camera_name: ""
        rule_id: ""
        rule_name: ""
        message: Server is running in fallback client-side reasoning mode
        timestamp: "2026-02-18T03:44:00.000000"
    SystemEvent:
      allOf:
        - $ref: '#/components/schemas/AlertEventBase'
        - type: object
          properties:
            event_type:
              type: string
              enum: [system]
          required:
            - event_type
      example:
        event_id: evt_sys_001
        event_type: system
        camera_id: ""
        camera_name: ""
        rule_id: ""
        rule_name: ""
        message: Monitoring subsystem initialized
        timestamp: "2026-02-18T03:45:00.000000"
    AlertEvent:
      oneOf:
        - $ref: '#/components/schemas/WatchRuleTriggeredEvent'
        - $ref: '#/components/schemas/CameraAlertPendingEvalEvent'
        - $ref: '#/components/schemas/ProviderErrorEvent'
        - $ref: '#/components/schemas/RuleEvalErrorEvent'
        - $ref: '#/components/schemas/StartupWarningEvent'
        - $ref: '#/components/schemas/SystemEvent'
      discriminator:
        propertyName: event_type
        mapping:
          watch_rule_triggered: '#/components/schemas/WatchRuleTriggeredEvent'
          camera_alert_pending_eval: '#/components/schemas/CameraAlertPendingEvalEvent'
          provider_error: '#/components/schemas/ProviderErrorEvent'
          rule_eval_error: '#/components/schemas/RuleEvalErrorEvent'
          startup_warning: '#/components/schemas/StartupWarningEvent'
          system: '#/components/schemas/SystemEvent'
    AlertsResponse:
      type: object
      properties:
        events:
          type: array
          items:
            $ref: '#/components/schemas/AlertEvent'
        count:
          type: integer
        timestamp:
          type: number
      required:
        - events
        - count
