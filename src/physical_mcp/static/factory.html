<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>physical-mcp — Product Architecture</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
:root {
  --bg: #0d1117;
  --surface: #161b22;
  --surface2: #21262d;
  --surface3: #2d333b;
  --border: #30363d;
  --belt: #e94560;
  --belt-glow: #e9456044;
  --accent: #58a6ff;
  --green: #3fb950;
  --yellow: #d29922;
  --red: #f85149;
  --orange: #db6d28;
  --purple: #bc8cff;
  --cyan: #39d2c0;
  --text: #e6edf3;
  --dim: #8b949e;
  --grid: #1b2230;
  --particle: #ff6b6b;
}
html, body { height:100%; overflow:hidden; background:var(--bg); color:var(--text); font-family:'SF Mono','Fira Code','JetBrains Mono','Consolas',monospace; }

/* ─── Canvas ─────────────────────────────────────────── */
#canvas-wrap { position:relative; width:100%; height:100%; overflow:hidden; cursor:grab; }
#canvas-wrap.grabbing { cursor:grabbing; }
#factory { position:absolute; transform-origin:0 0; will-change:transform; }
#canvas-wrap::before {
  content:''; position:absolute; inset:0; z-index:0;
  background-image:
    linear-gradient(var(--grid) 1px, transparent 1px),
    linear-gradient(90deg, var(--grid) 1px, transparent 1px);
  background-size:48px 48px; opacity:0.5;
}

/* ─── Nodes ──────────────────────────────────────────── */
.node {
  position:absolute; background:var(--surface); border:2px solid var(--border);
  border-radius:12px; padding:16px 20px; min-width:180px;
  cursor:pointer; transition:border-color 0.2s, box-shadow 0.2s;
  z-index:2; user-select:none;
}
.node:hover { border-color:var(--accent); box-shadow:0 0 24px rgba(88,166,255,0.2); z-index:10; }
.node.active { border-color:var(--green); box-shadow:0 0 16px rgba(63,185,80,0.2); }
.node.warn { border-color:var(--yellow); box-shadow:0 0 16px rgba(210,153,34,0.2); }
.node.error { border-color:var(--red); box-shadow:0 0 16px rgba(248,81,73,0.2); }
.node.dragging { opacity:0.85; z-index:100; cursor:grabbing; box-shadow:0 8px 32px rgba(0,0,0,0.5); }
.node.selected { outline:2px solid var(--accent); outline-offset:2px; }
.node.highlight { border-color:var(--purple); box-shadow:0 0 20px rgba(188,140,255,0.3); }
.node.dim-node { opacity:0.3; transition:opacity 0.3s; }
.node-icon { font-size:30px; margin-bottom:6px; }
.node-title { font-size:14px; font-weight:700; color:var(--text); white-space:nowrap; }
.node-sub { font-size:10px; color:var(--dim); margin-top:4px; white-space:nowrap; max-width:220px; overflow:hidden; text-overflow:ellipsis; }
.node-file { font-size:9px; color:#484f58; margin-top:5px; font-style:italic; }
.node-badge {
  position:absolute; top:-8px; right:-8px;
  background:var(--green); color:#000; font-size:9px; font-weight:700;
  padding:2px 8px; border-radius:10px; min-width:20px; text-align:center;
}
.node-badge.warn { background:var(--yellow); }
.node-badge.err { background:var(--red); color:#fff; }
.node-badge.new { background:var(--cyan); }
.node-status-dot {
  position:absolute; top:10px; left:10px;
  width:8px; height:8px; border-radius:50%;
  background:var(--dim); transition:background 0.3s;
}
.node-status-dot.online { background:var(--green); box-shadow:0 0 6px var(--green); }
.node-status-dot.processing { background:var(--accent); box-shadow:0 0 6px var(--accent); animation:pulse 1s ease-in-out infinite; }
.node-status-dot.idle { background:var(--yellow); }
.node-status-dot.offline { background:var(--red); box-shadow:0 0 6px var(--red); }

/* Consumer node special styling */
.node.consumer {
  background:linear-gradient(135deg, #161b22, #1a1525);
  border-color:var(--purple);
}
.node.cloud-node {
  background:linear-gradient(135deg, #161b22, #0d1a2a);
  border-color:var(--accent);
}
.node.chat-node {
  background:linear-gradient(135deg, #161b22, #0d2018);
  border-color:var(--green);
}

/* ─── Section labels ─────────────────────────────────── */
.section-label {
  position:absolute; z-index:3;
  font-size:12px; font-weight:700; letter-spacing:2px; text-transform:uppercase;
  color:var(--belt); opacity:0.7; white-space:nowrap; cursor:pointer;
  display:flex; align-items:center; gap:8px;
  transition:opacity 0.2s;
}
.section-label:hover { opacity:1; }
.section-label::after {
  content:''; display:block; flex:1; min-width:40px; height:1px;
  background:linear-gradient(90deg, var(--belt), transparent); margin-top:0;
}
.section-label .section-toggle {
  font-size:10px; transition:transform 0.3s; display:inline-block;
}
.section-label.collapsed .section-toggle { transform:rotate(-90deg); }
.section-label .section-count {
  font-size:9px; color:var(--dim); background:var(--surface2);
  padding:1px 6px; border-radius:8px; font-weight:400;
}
.section-label.collapsed { opacity:0.35; }
.node.section-hidden { display:none !important; }

/* ─── SVG belts ──────────────────────────────────────── */
#belts { position:absolute; top:0; left:0; z-index:1; pointer-events:none; overflow:visible; }
.belt-path {
  fill:none; stroke:var(--belt); stroke-width:2.5; stroke-dasharray:8 6;
  opacity:0.6; filter:drop-shadow(0 0 3px var(--belt-glow));
  pointer-events:stroke; cursor:pointer;
}
.belt-path.flowing { animation:belt-flow 1s linear infinite; }
.belt-path.belt-hover { stroke-width:4; opacity:1; stroke:var(--accent); }
.belt-path.belt-selected { stroke-width:4; opacity:1; stroke:var(--purple); }
@keyframes belt-flow { to { stroke-dashoffset: -14; } }
.belt-junction { fill:var(--belt); filter:drop-shadow(0 0 5px var(--belt-glow)); }
.data-particle { fill:var(--particle); filter:drop-shadow(0 0 4px var(--particle)); }
@keyframes particle-glow { 0%,100%{opacity:1;r:3.5;}50%{opacity:0.6;r:2.5;} }
.data-particle { animation:particle-glow 0.8s ease-in-out infinite; }
.belt-label { font-size:9px; fill:var(--dim); font-family:inherit; text-anchor:middle; dominant-baseline:middle; }
.belt-label-bg { fill:var(--bg); rx:3; opacity:0.85; }

/* ─── HUD overlay ────────────────────────────────────── */
#hud {
  position:fixed; top:16px; left:16px; z-index:50;
  display:flex; gap:10px; align-items:center; flex-wrap:wrap;
}
.hud-item {
  background:var(--surface); border:1px solid var(--border); border-radius:8px;
  padding:8px 14px; font-size:11px; display:flex; align-items:center; gap:6px;
}
.hud-item .hud-dot { width:6px; height:6px; border-radius:50%; background:var(--green); }
.hud-item .hud-dot.off { background:var(--red); }
.hud-item .hud-dot.warn { background:var(--yellow); }
.hud-item .val { color:var(--green); font-weight:700; }

/* ─── Zoom controls ──────────────────────────────────── */
#zoom-ctrl {
  position:fixed; bottom:16px; right:16px; z-index:50;
  display:flex; flex-direction:column; gap:4px;
}
#zoom-ctrl button {
  background:var(--surface); border:1px solid var(--border); border-radius:6px;
  color:var(--text); width:36px; height:36px; font-size:18px; cursor:pointer;
  display:flex; align-items:center; justify-content:center; transition:all 0.15s;
}
#zoom-ctrl button:hover { background:var(--surface2); border-color:var(--accent); }
#zoom-pct { font-size:10px; color:var(--dim); text-align:center; }

/* ─── Search bar ─────────────────────────────────────── */
#search-bar {
  position:fixed; top:16px; right:16px; z-index:60;
  display:flex; gap:6px; align-items:center;
}
#search-input {
  background:var(--surface); border:1px solid var(--border); border-radius:8px;
  color:var(--text); padding:8px 14px 8px 36px; font-size:12px; font-family:inherit;
  width:220px; outline:none; transition:border-color 0.2s, width 0.2s;
}
#search-input:focus { border-color:var(--accent); width:280px; }
#search-icon {
  position:absolute; left:12px; top:50%; transform:translateY(-50%);
  color:var(--dim); font-size:14px; pointer-events:none;
}
#search-results {
  position:absolute; top:42px; left:0; right:0;
  background:var(--surface); border:1px solid var(--border); border-radius:8px;
  max-height:240px; overflow-y:auto; display:none; z-index:61;
}
#search-results.show { display:block; }
.search-item {
  padding:8px 14px; cursor:pointer; font-size:12px;
  display:flex; align-items:center; gap:8px;
  border-bottom:1px solid var(--border);
}
.search-item:hover { background:var(--surface2); }
.search-item:last-child { border-bottom:none; }
.search-item .si-icon { font-size:16px; }
.search-item .si-title { color:var(--text); font-weight:600; }
.search-item .si-file { color:var(--dim); font-size:10px; margin-left:auto; }

/* ─── Detail panel ───────────────────────────────────── */
#detail {
  position:fixed; right:-440px; top:0; width:440px; height:100%;
  background:var(--surface); border-left:2px solid var(--belt);
  z-index:100; transition:right 0.3s cubic-bezier(0.4,0,0.2,1);
  overflow-y:auto; padding:24px;
}
#detail.open { right:0; }
#detail-close {
  position:absolute; top:12px; right:12px; background:none; border:none;
  color:var(--dim); font-size:22px; cursor:pointer; width:32px; height:32px;
  display:flex; align-items:center; justify-content:center;
  border-radius:6px; transition:all 0.15s;
}
#detail-close:hover { color:var(--text); background:var(--surface2); }
#detail h2 { font-size:18px; margin-bottom:4px; }
#detail .detail-icon { font-size:36px; margin-bottom:8px; }
#detail .detail-file { font-size:11px; color:var(--accent); margin-bottom:16px; font-family:inherit; }
#detail .detail-desc { font-size:12px; color:var(--dim); line-height:1.7; margin-bottom:20px; }
#detail .detail-section { font-size:11px; color:var(--belt); font-weight:700; letter-spacing:1px; margin:16px 0 8px; text-transform:uppercase; }
#detail .detail-stats { list-style:none; }
#detail .detail-stats li {
  font-size:12px; padding:10px 0; border-bottom:1px solid var(--border);
  display:flex; justify-content:space-between; align-items:center;
}
#detail .detail-stats .val { color:var(--green); font-weight:700; }
#detail .detail-stats .val.warn { color:var(--yellow); }
#detail .detail-stats .val.err { color:var(--red); }
#detail-live { margin-top:8px; }
.live-item {
  font-size:11px; color:var(--dim); padding:6px 0;
  border-bottom:1px solid var(--border); cursor:pointer;
}
.live-item .lk { color:var(--accent); }
.live-item .lv { color:var(--green); font-weight:600; float:right; }
.detail-actions { display:flex; gap:8px; margin-top:16px; flex-wrap:wrap; }
.detail-btn {
  background:var(--surface2); border:1px solid var(--border); border-radius:6px;
  color:var(--text); padding:6px 12px; font-size:11px; cursor:pointer;
  font-family:inherit; transition:all 0.15s;
}
.detail-btn:hover { background:var(--border); border-color:var(--accent); }

/* ─── Mini-map ───────────────────────────────────────── */
#minimap {
  position:fixed; bottom:16px; left:16px; z-index:50;
  width:200px; height:120px;
  background:var(--surface); border:1px solid var(--border); border-radius:8px;
  overflow:hidden; cursor:pointer;
}
#minimap canvas { width:100%; height:100%; }
#minimap .viewport {
  position:absolute; border:1.5px solid var(--accent);
  border-radius:2px; pointer-events:none; background:rgba(88,166,255,0.08);
}

/* ─── Scene feed ─────────────────────────────────────── */
#scene-feed {
  position:fixed; bottom:150px; left:16px; z-index:50;
  width:220px; max-height:220px; overflow-y:auto;
  background:var(--surface); border:1px solid var(--border); border-radius:8px;
  padding:10px; font-size:9px; color:var(--dim);
}
#scene-feed .feed-title { color:var(--accent); font-weight:700; font-size:10px; margin-bottom:6px; display:flex; justify-content:space-between; align-items:center; }
#scene-feed .feed-title button { background:none; border:none; color:var(--dim); cursor:pointer; font-size:10px; }
.feed-item { padding:4px 0; border-bottom:1px solid var(--border); line-height:1.4; }
.feed-item:last-child { border-bottom:none; }
.feed-time { color:var(--dim); }
.feed-text { color:var(--text); }

/* ─── Toast notifications ────────────────────────────── */
#toast-container {
  position:fixed; top:70px; right:16px; z-index:200;
  display:flex; flex-direction:column; gap:8px; width:320px;
}
.toast {
  background:var(--surface); border:1px solid var(--border); border-radius:8px;
  padding:12px 16px; font-size:12px; animation:toast-in 0.3s ease;
  display:flex; gap:10px; align-items:flex-start;
  box-shadow:0 4px 16px rgba(0,0,0,0.3);
}
.toast.alert { border-color:var(--red); }
.toast.info { border-color:var(--accent); }
.toast.success { border-color:var(--green); }
.toast-icon { font-size:18px; flex-shrink:0; }
.toast-body { flex:1; }
.toast-title { font-weight:700; margin-bottom:2px; }
.toast-msg { color:var(--dim); font-size:11px; }
.toast-close { background:none; border:none; color:var(--dim); cursor:pointer; font-size:16px; }
@keyframes toast-in { from{transform:translateX(100%);opacity:0;} to{transform:translateX(0);opacity:1;} }
@keyframes toast-out { from{opacity:1;} to{opacity:0;transform:translateY(-20px);} }

/* ─── Toolbar ────────────────────────────────────────── */
#toolbar {
  position:fixed; top:54px; right:16px; z-index:55;
  display:flex; gap:6px; align-items:center;
}
.toolbar-btn {
  background:var(--surface); border:1px solid var(--border); border-radius:6px;
  color:var(--dim); padding:6px 10px; font-size:10px; cursor:pointer;
  font-family:inherit; transition:all 0.15s; display:flex; align-items:center; gap:4px;
}
.toolbar-btn:hover { color:var(--text); border-color:var(--accent); }

/* ─── Help overlay ───────────────────────────────────── */
#help-overlay {
  position:fixed; inset:0; z-index:300; display:none;
  background:rgba(13,17,23,0.92); backdrop-filter:blur(8px);
  align-items:center; justify-content:center;
}
#help-overlay.show { display:flex; }
#help-box {
  background:var(--surface); border:1px solid var(--border); border-radius:12px;
  padding:32px; max-width:560px; width:90%;
}
#help-box h2 { font-size:16px; color:var(--belt); margin-bottom:16px; letter-spacing:1px; }
.help-row { display:flex; justify-content:space-between; padding:4px 0; font-size:12px; }
.help-row .help-keys { display:flex; gap:4px; }
.help-row .help-desc { color:var(--dim); }
.kb { background:var(--surface2); border:1px solid var(--border); border-radius:3px; padding:1px 5px; font-size:9px; }
#help-close { float:right; background:none; border:none; color:var(--dim); font-size:20px; cursor:pointer; }
#help-close:hover { color:var(--text); }

/* ─── Consumer flow callout ──────────────────────────── */
.flow-callout {
  position:absolute; z-index:3;
  background:linear-gradient(135deg, rgba(233,69,96,0.1), rgba(88,166,255,0.05));
  border:1px dashed rgba(233,69,96,0.3); border-radius:16px;
  padding:16px 20px;
}
.flow-callout h3 {
  font-size:11px; color:var(--belt); letter-spacing:2px; text-transform:uppercase;
  margin-bottom:6px;
}
.flow-callout p {
  font-size:10px; color:var(--dim); line-height:1.5;
}
.flow-step {
  font-size:24px; color:var(--belt); opacity:0.15; font-weight:900;
  position:absolute; top:8px; right:12px;
}

/* ─── Animations ─────────────────────────────────────── */
@keyframes pulse { 0%,100%{opacity:1;}50%{opacity:0.7;} }
.pulse { animation:pulse 2s ease-in-out infinite; }
@keyframes fade-in { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
.fade-in { animation:fade-in 0.3s ease; }

/* ─── Scrollbar ──────────────────────────────────────── */
::-webkit-scrollbar { width:6px; }
::-webkit-scrollbar-track { background:var(--bg); }
::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }
::-webkit-scrollbar-thumb:hover { background:var(--dim); }

/* ─── Responsive ─────────────────────────────────────── */
@media (max-width: 600px) {
  #search-input { width:120px; font-size:11px; }
  #search-input:focus { width:160px; }
  #scene-feed { width:140px; max-height:140px; }
  #minimap { width:120px; height:72px; }
}
@media (max-width: 420px) {
  #scene-feed { display:none; }
  #minimap { display:none; }
}
</style>
</head>
<body>

<div id="hud">
  <div class="hud-item"><div class="hud-dot" id="hud-health-dot"></div> Cameras <span class="val" id="hud-cams">0</span></div>
  <div class="hud-item">Rules <span class="val" id="hud-rules">0</span></div>
  <div class="hud-item">Alerts <span class="val" id="hud-alerts">0</span></div>
  <div class="hud-item">FPS <span class="val" id="hud-fps">&mdash;</span></div>
</div>

<div id="search-bar">
  <span id="search-icon">&#128269;</span>
  <input type="text" id="search-input" placeholder="Search modules... (Ctrl+K)" autocomplete="off">
  <div id="search-results"></div>
</div>

<div id="zoom-ctrl">
  <button onclick="zoomIn()" title="Zoom in (+)">+</button>
  <button onclick="zoomOut()" title="Zoom out (-)">&#8722;</button>
  <div id="zoom-pct">55%</div>
  <button onclick="resetView()" title="Reset view (Home)">&#8962;</button>
  <button onclick="fitAll()" title="Fit all (F)">&#9635;</button>
</div>

<div id="minimap"><canvas id="minimap-canvas"></canvas><div class="viewport" id="minimap-vp"></div></div>

<div id="scene-feed">
  <div class="feed-title">LIVE SCENE FEED <button onclick="clearFeed()">clear</button></div>
  <div id="feed-items"><div class="feed-item"><span class="feed-text" style="color:var(--dim);">Waiting for data...</span></div></div>
</div>

<div id="toast-container"></div>

<div id="toolbar">
  <button class="toolbar-btn" onclick="toggleHelp()" title="Help (?)">&#10067; Help</button>
</div>

<div id="canvas-wrap">
  <div id="factory">
    <svg id="belts" width="3200" height="1200" style="position:absolute;top:0;left:0;overflow:visible;"></svg>

    <!-- ═══════════════════════════════════════════════════ -->
    <!-- SECTION: YOUR CAMERAS                              -->
    <!-- ═══════════════════════════════════════════════════ -->
    <div class="section-label" data-section="cameras" style="left:40px;top:24px;width:300px;">
      <span class="section-toggle">&#9660;</span> &#128247; YOUR CAMERAS <span class="section-count">5</span>
    </div>

    <div class="node consumer" id="n-yoosee" style="left:60px;top:80px;" data-id="yoosee" data-section="cameras">
      <div class="node-status-dot" id="status-yoosee"></div>
      <div class="node-icon">&#128249;</div>
      <div class="node-title">WiFi Camera (Yoosee)</div>
      <div class="node-sub">RTSP &middot; &#165;25-40 &middot; plug and play</div>
      <div class="node-file">rtsp://admin:admin@IP:554/onvif1</div>
      <div class="node-badge new">RECOMMENDED</div>
    </div>

    <div class="node consumer" id="n-ipcam" style="left:60px;top:240px;" data-id="ipcam" data-section="cameras">
      <div class="node-status-dot" id="status-ipcam"></div>
      <div class="node-icon">&#128225;</div>
      <div class="node-title">IP Camera (ONVIF)</div>
      <div class="node-sub">TP-Link &middot; Mercury &middot; Dahua</div>
      <div class="node-file">camera/rtsp.py</div>
    </div>

    <div class="node consumer" id="n-usb" style="left:60px;top:390px;" data-id="usb" data-section="cameras">
      <div class="node-status-dot" id="status-usb"></div>
      <div class="node-icon">&#128247;</div>
      <div class="node-title">USB / Laptop Camera</div>
      <div class="node-sub">OpenCV &middot; built-in webcam</div>
      <div class="node-file">camera/usb.py</div>
    </div>

    <div class="node consumer" id="n-phone" style="left:60px;top:530px;" data-id="phone" data-section="cameras">
      <div class="node-icon">&#128241;</div>
      <div class="node-title">Phone Camera</div>
      <div class="node-sub">DroidCam &middot; IP Webcam app</div>
      <div class="node-file">MJPEG over HTTP</div>
    </div>

    <div class="node" id="n-cloud-cam" style="left:60px;top:670px;" data-id="cloud-cam" data-section="cameras">
      <div class="node-icon">&#9729;&#65039;</div>
      <div class="node-title">Cloud Camera</div>
      <div class="node-sub">Receives pushed JPEG frames</div>
      <div class="node-file">camera/cloud.py</div>
      <div class="node-badge new">NEW</div>
    </div>

    <!-- ═══════════════════════════════════════════════════ -->
    <!-- SECTION: RELAY                                     -->
    <!-- ═══════════════════════════════════════════════════ -->
    <div class="section-label" data-section="relay" style="left:400px;top:24px;width:300px;">
      <span class="section-toggle">&#9660;</span> &#128259; RELAY AGENT <span class="section-count">3</span>
    </div>

    <div class="flow-callout" style="left:390px;top:400px;width:260px;">
      <div class="flow-step">2</div>
      <h3>Bridge to Cloud</h3>
      <p>Relay pulls video from camera on your WiFi, compresses to JPEG, pushes to cloud over HTTPS. Runs on any device.</p>
    </div>

    <div class="node" id="n-relay" style="left:420px;top:80px;" data-id="relay" data-section="relay">
      <div class="node-status-dot" id="status-relay"></div>
      <div class="node-icon">&#128259;</div>
      <div class="node-title">Relay Agent</div>
      <div class="node-sub">RTSP pull &rarr; JPEG &rarr; HTTPS POST</div>
      <div class="node-file">relay/relay_agent.py</div>
      <div class="node-badge pulse">BRIDGE</div>
    </div>

    <div class="node" id="n-provision" style="left:420px;top:240px;" data-id="provision" data-section="relay">
      <div class="node-icon">&#128246;</div>
      <div class="node-title">WiFi Provisioning</div>
      <div class="node-sub">AP mode &middot; captive portal</div>
      <div class="node-file">relay/wifi_provision.py</div>
    </div>

    <div class="node" id="n-pair" style="left:420px;top:390px;" data-id="pair" data-section="relay">
      <div class="node-icon">&#128279;</div>
      <div class="node-title">Claim Code Pairing</div>
      <div class="node-sub">6-digit code &middot; links camera to user</div>
      <div class="node-file">relay/pair.py</div>
    </div>

    <!-- ═══════════════════════════════════════════════════ -->
    <!-- SECTION: CLOUD SERVER                              -->
    <!-- ═══════════════════════════════════════════════════ -->
    <div class="section-label" data-section="cloud" style="left:780px;top:24px;width:340px;">
      <span class="section-toggle">&#9660;</span> &#9729;&#65039; CLOUD SERVER (FLY.IO) <span class="section-count">5</span>
    </div>

    <div class="node cloud-node" id="n-push" style="left:800px;top:80px;" data-id="push" data-section="cloud">
      <div class="node-status-dot" id="status-push"></div>
      <div class="node-icon">&#128229;</div>
      <div class="node-title">Push Endpoints</div>
      <div class="node-sub">POST /push/frame &middot; /push/register</div>
      <div class="node-file">vision_api.py</div>
      <div class="node-badge new">NEW</div>
    </div>

    <div class="node cloud-node" id="n-buffer" style="left:800px;top:240px;" data-id="buffer" data-section="cloud">
      <div class="node-status-dot" id="status-buffer"></div>
      <div class="node-icon">&#128230;</div>
      <div class="node-title">FrameBuffer</div>
      <div class="node-sub">async ring &middot; 300 frames</div>
      <div class="node-file">camera/buffer.py</div>
    </div>

    <div class="node cloud-node" id="n-loop" style="left:800px;top:400px;min-width:300px;border-color:var(--belt);background:linear-gradient(135deg,var(--surface),#1a1020);" data-id="loop" data-section="cloud">
      <div class="node-status-dot" id="status-loop"></div>
      <div class="node-icon">&#9889;</div>
      <div class="node-title">Perception Loop &mdash; the reactor</div>
      <div class="node-sub">1 async task per camera &middot; wires entire pipeline</div>
      <div class="node-file">perception/loop.py</div>
      <div class="node-badge pulse">RUNNING</div>
    </div>

    <div class="node cloud-node" id="n-api" style="left:800px;top:570px;" data-id="api" data-section="cloud">
      <div class="node-status-dot" id="status-api"></div>
      <div class="node-icon">&#127760;</div>
      <div class="node-title">Vision API :8090</div>
      <div class="node-sub">18+ endpoints &middot; dashboard &middot; CORS</div>
      <div class="node-file">vision_api.py</div>
      <div class="node-badge pulse">LIVE</div>
    </div>

    <div class="node cloud-node" id="n-mcp" style="left:800px;top:720px;" data-id="mcp" data-section="cloud">
      <div class="node-status-dot" id="status-mcp"></div>
      <div class="node-icon">&#128642;</div>
      <div class="node-title">MCP Server :8400</div>
      <div class="node-sub">Claude &middot; Cursor &middot; VS Code &middot; Gemini</div>
      <div class="node-file">server.py</div>
    </div>

    <!-- ═══════════════════════════════════════════════════ -->
    <!-- SECTION: AI BRAIN                                  -->
    <!-- ═══════════════════════════════════════════════════ -->
    <div class="section-label" data-section="brain" style="left:1240px;top:24px;width:280px;">
      <span class="section-toggle">&#9660;</span> &#129504; AI BRAIN <span class="section-count">4</span>
    </div>

    <div class="node" id="n-detector" style="left:1260px;top:80px;" data-id="detector" data-section="brain">
      <div class="node-icon">&#128065;</div>
      <div class="node-title">ChangeDetector</div>
      <div class="node-sub">pHash + pixel diff &lt;5ms</div>
      <div class="node-file">perception/change_detector.py</div>
    </div>

    <div class="node" id="n-sampler" style="left:1260px;top:240px;" data-id="sampler" data-section="brain">
      <div class="node-icon">&#9201;</div>
      <div class="node-title">FrameSampler</div>
      <div class="node-sub">cost gate &middot; debounce 3s</div>
      <div class="node-file">perception/frame_sampler.py</div>
    </div>

    <div class="node" id="n-analyzer" style="left:1260px;top:400px;" data-id="analyzer" data-section="brain">
      <div class="node-status-dot" id="status-analyzer"></div>
      <div class="node-icon">&#129504;</div>
      <div class="node-title">FrameAnalyzer</div>
      <div class="node-sub">LLM vision API &middot; "what do you see?"</div>
      <div class="node-file">reasoning/analyzer.py</div>
    </div>

    <div class="node" id="n-scene" style="left:1260px;top:570px;" data-id="scene" data-section="brain">
      <div class="node-icon">&#127916;</div>
      <div class="node-title">SceneState</div>
      <div class="node-sub">summary &middot; objects &middot; people &middot; context</div>
      <div class="node-file">perception/scene_state.py</div>
    </div>

    <!-- ═══════════════════════════════════════════════════ -->
    <!-- SECTION: RULES                                     -->
    <!-- ═══════════════════════════════════════════════════ -->
    <div class="section-label" data-section="rules" style="left:1640px;top:24px;width:240px;">
      <span class="section-toggle">&#9660;</span> &#9878;&#65039; WATCH RULES <span class="section-count">3</span>
    </div>

    <div class="node" id="n-engine" style="left:1660px;top:80px;" data-id="engine" data-section="rules">
      <div class="node-status-dot" id="status-engine"></div>
      <div class="node-icon">&#9878;&#65039;</div>
      <div class="node-title">RulesEngine</div>
      <div class="node-sub">evaluate conditions &middot; fire alerts</div>
      <div class="node-file">rules/engine.py</div>
    </div>

    <div class="node" id="n-templates" style="left:1660px;top:240px;" data-id="templates" data-section="rules">
      <div class="node-icon">&#128203;</div>
      <div class="node-title">Rule Templates</div>
      <div class="node-sub">person &middot; package &middot; pet &middot; pantry</div>
      <div class="node-file">rules/templates.py</div>
    </div>

    <div class="node" id="n-store" style="left:1660px;top:400px;" data-id="store" data-section="rules">
      <div class="node-icon">&#128190;</div>
      <div class="node-title">RulesStore</div>
      <div class="node-sub">YAML persistence &middot; CRUD</div>
      <div class="node-file">rules/store.py</div>
    </div>

    <!-- ═══════════════════════════════════════════════════ -->
    <!-- SECTION: CHAT — THE USER INTERFACE                 -->
    <!-- ═══════════════════════════════════════════════════ -->
    <div class="section-label" data-section="chat" style="left:2000px;top:24px;width:340px;">
      <span class="section-toggle">&#9660;</span> &#128172; CHAT WITH YOUR CAMERA <span class="section-count">6</span>
    </div>

    <div class="flow-callout" style="left:1990px;top:530px;width:300px;">
      <div class="flow-step">3</div>
      <h3>Your Interface</h3>
      <p>No app to install. Just message your camera on Telegram, WhatsApp, Discord, or Slack. Ask questions, set rules, get alerts.</p>
    </div>

    <div class="node chat-node" id="n-tgbot" style="left:2020px;top:80px;" data-id="tgbot" data-section="chat">
      <div class="node-status-dot" id="status-tgbot"></div>
      <div class="node-icon">&#128172;</div>
      <div class="node-title">Telegram Bot</div>
      <div class="node-sub">/snap &middot; /watch &middot; /scene &middot; free text chat</div>
      <div class="node-file">bot/telegram_bot.py</div>
      <div class="node-badge new">NEW</div>
    </div>

    <div class="node chat-node" id="n-whatsapp" style="left:2020px;top:240px;" data-id="whatsapp" data-section="chat">
      <div class="node-icon">&#128242;</div>
      <div class="node-title">WhatsApp</div>
      <div class="node-sub">via OpenClaw &middot; Baileys</div>
      <div class="node-file">OpenClaw channel</div>
    </div>

    <div class="node chat-node" id="n-discord-ch" style="left:2220px;top:80px;" data-id="discord-ch" data-section="chat">
      <div class="node-icon">&#127918;</div>
      <div class="node-title">Discord</div>
      <div class="node-sub">via OpenClaw &middot; bot commands</div>
      <div class="node-file">OpenClaw channel</div>
    </div>

    <div class="node chat-node" id="n-slack-ch" style="left:2220px;top:240px;" data-id="slack-ch" data-section="chat">
      <div class="node-icon">&#128188;</div>
      <div class="node-title">Slack</div>
      <div class="node-sub">via OpenClaw &middot; Block Kit</div>
      <div class="node-file">OpenClaw channel</div>
    </div>

    <div class="node chat-node" id="n-signal" style="left:2220px;top:400px;" data-id="signal" data-section="chat">
      <div class="node-icon">&#128274;</div>
      <div class="node-title">Signal</div>
      <div class="node-sub">via OpenClaw &middot; signal-cli</div>
      <div class="node-file">OpenClaw channel</div>
    </div>

    <div class="node" id="n-dispatch" style="left:2020px;top:400px;" data-id="dispatch" data-section="chat">
      <div class="node-status-dot" id="status-dispatch"></div>
      <div class="node-icon">&#128236;</div>
      <div class="node-title">Alert Dispatcher</div>
      <div class="node-sub">routes alerts to all channels</div>
      <div class="node-file">notifications/__init__.py</div>
    </div>

    <!-- ═══════════════════════════════════════════════════ -->
    <!-- CONSUMER FLOW CALLOUTS                             -->
    <!-- ═══════════════════════════════════════════════════ -->
    <div class="flow-callout" style="left:30px;top:810px;width:300px;">
      <div class="flow-step">1</div>
      <h3>Buy Any Camera</h3>
      <p>Yoosee WiFi camera (&#165;25), TP-Link, or any IP camera with RTSP. Even your laptop webcam or phone works.</p>
    </div>

  </div>
</div>

<!-- Detail panel -->
<div id="detail">
  <button id="detail-close" onclick="closeDetail()">&times;</button>
  <div id="detail-icon" class="detail-icon"></div>
  <h2 id="detail-title">&mdash;</h2>
  <div class="detail-file" id="detail-file">&mdash;</div>
  <div class="detail-desc" id="detail-desc">&mdash;</div>
  <div class="detail-section">SPECIFICATIONS</div>
  <ul class="detail-stats" id="detail-stats"></ul>
  <div id="detail-live"></div>
  <div class="detail-actions" id="detail-actions"></div>
</div>

<!-- Help overlay -->
<div id="help-overlay">
  <div id="help-box">
    <button id="help-close" onclick="toggleHelp()">&times;</button>
    <h2>&#128247; PHYSICAL-MCP PRODUCT ARCHITECTURE</h2>
    <div style="font-size:12px;color:var(--dim);line-height:1.7;margin-bottom:16px;">
      <strong style="color:var(--text);">How it works:</strong> Buy a camera &rarr; Relay bridges it to cloud &rarr; AI understands what it sees &rarr; Chat with it on Telegram/WhatsApp<br><br>
      <strong style="color:var(--text);">No app. No terminal. Just message your camera.</strong>
    </div>
    <div style="margin-bottom:16px;">
      <h3 style="font-size:12px;color:var(--accent);margin-bottom:8px;text-transform:uppercase;letter-spacing:1px;">Navigation</h3>
      <div class="help-row"><span class="help-desc">Pan canvas</span><span class="help-keys"><span class="kb">Drag</span></span></div>
      <div class="help-row"><span class="help-desc">Zoom in/out</span><span class="help-keys"><span class="kb">+</span> <span class="kb">-</span> or <span class="kb">Scroll</span></span></div>
      <div class="help-row"><span class="help-desc">Reset view</span><span class="help-keys"><span class="kb">Home</span></span></div>
      <div class="help-row"><span class="help-desc">Fit all</span><span class="help-keys"><span class="kb">F</span></span></div>
      <div class="help-row"><span class="help-desc">Search</span><span class="help-keys"><span class="kb">Ctrl</span>+<span class="kb">K</span></span></div>
      <div class="help-row"><span class="help-desc">Inspect node</span><span class="help-keys"><span class="kb">Click</span></span></div>
      <div class="help-row"><span class="help-desc">This help</span><span class="help-keys"><span class="kb">?</span></span></div>
    </div>
  </div>
</div>

<script>
const TOKEN = '{{AUTH_TOKEN}}';
const BASE = window.location.origin;
const H = TOKEN ? {'Authorization':'Bearer '+TOKEN} : {};
const STORAGE_KEY = 'physical-mcp-factory-v2';

// ═══════════════════════════════════════════════════════════
// NODE METADATA
// ═══════════════════════════════════════════════════════════
const META = {
  yoosee:{icon:'&#128249;',title:'WiFi Camera (Yoosee)',file:'RTSP camera — no code needed',
    desc:'Cheapest option: buy a Yoosee-based WiFi camera for ¥25-40 on Taobao. Enable RTSP in the Yoosee app. Standard URL: rtsp://admin:admin@IP:554/onvif1. Plug in, connect to WiFi, done.',
    stats:[['Price','¥25-40'],['Protocol','RTSP'],['Resolution','1080p'],['WiFi','2.4GHz'],['Night vision','IR LEDs'],['Setup','Yoosee app → enable RTSP']]},
  ipcam:{icon:'&#128225;',title:'IP Camera (ONVIF)',file:'camera/rtsp.py',
    desc:'Any ONVIF-compatible IP camera. TP-Link, Mercury (水星), Dahua, Hikvision all work. RTSP URL varies by brand. Auto-discovered via ONVIF WS-Discovery.',
    stats:[['Brands','TP-Link, Mercury, Dahua, Hikvision'],['Protocol','RTSP + ONVIF'],['Discovery','WS-Discovery multicast'],['Price','¥79-300+'],['Reconnect','Auto (2s→30s backoff)']]},
  usb:{icon:'&#128247;',title:'USB / Laptop Camera',file:'camera/usb.py (120 lines)',
    desc:'Built-in webcam or USB camera. OpenCV background capture at ~2fps. Zero cost if you already have a laptop. Great for testing.',
    stats:[['Capture','Background thread'],['FPS','~2'],['Cost','Free (built-in)'],['Platforms','Mac/Win/Linux']]},
  phone:{icon:'&#128241;',title:'Phone Camera',file:'DroidCam or IP Webcam app',
    desc:'Turn your old phone into a camera. Install DroidCam (Android/iOS) or IP Webcam (Android). Streams MJPEG over HTTP on your local network.',
    stats:[['Android','DroidCam / IP Webcam'],['iOS','DroidCam'],['Protocol','MJPEG over HTTP'],['Cost','Free app']]},
  'cloud-cam':{icon:'&#9729;&#65039;',title:'Cloud Camera',file:'camera/cloud.py',
    desc:'NEW: Camera type that receives pushed JPEG frames via HTTP POST. No RTSP pull needed. The relay agent pushes frames to this endpoint.',
    stats:[['Method','HTTP POST'],['Auth','X-Camera-Token header'],['Format','JPEG'],['Max size','5MB per frame']]},
  relay:{icon:'&#128259;',title:'Relay Agent',file:'relay/relay_agent.py',
    desc:'The bridge between your camera and the cloud. Pulls RTSP video from camera on your local network, compresses frames to JPEG, POSTs them to the cloud server over HTTPS. Runs on any computer, Raspberry Pi, or phone.',
    stats:[['Input','RTSP stream'],['Output','HTTPS POST (JPEG)'],['Interval','~2fps'],['Retry','Exponential backoff'],['Runs on','Any Python device']]},
  provision:{icon:'&#128246;',title:'WiFi Provisioning',file:'relay/wifi_provision.py',
    desc:'For dedicated relay hardware: creates WiFi AP with captive portal. User connects phone, enters WiFi credentials + 6-digit claim code. Like setting up a smart bulb.',
    stats:[['Mode','AP + captive portal'],['Theme','DJI-style dark UI'],['Connects via','nmcli / wpa_supplicant'],['Registers','POST /push/register']]},
  pair:{icon:'&#128279;',title:'Claim Code Pairing',file:'relay/pair.py',
    desc:'Links a physical camera to a user account. Telegram bot generates a 6-digit code → user enters it on camera/relay → camera is paired to that Telegram chat.',
    stats:[['Code format','6-digit alphanumeric'],['Generated by','Telegram /setup command'],['Entered on','Captive portal or CLI'],['Expires','10 minutes']]},
  push:{icon:'&#128229;',title:'Push Endpoints',file:'vision_api.py',
    desc:'NEW: HTTP endpoints for receiving frames from relay agents. POST /push/frame/{camera_id} accepts JPEG with X-Camera-Token auth. POST /push/register creates new cloud cameras via claim code.',
    stats:[['POST /push/frame','Receive JPEG frame'],['POST /push/register','Claim code pairing'],['Auth','X-Camera-Token header'],['Size limit','5MB']]},
  buffer:{icon:'&#128230;',title:'FrameBuffer',file:'camera/buffer.py (59 lines)',
    desc:'Fixed-size async ring buffer. Stores recent frames for analysis. Supports time-range queries and even sampling.',
    stats:[['Max frames','300'],['Lock','asyncio.Lock'],['Queries','latest, since, sampled']]},
  loop:{icon:'&#9889;',title:'Perception Loop',file:'perception/loop.py (557 lines)',
    desc:'THE REACTOR CORE. One async task per camera. Orchestrates the entire pipeline: capture → buffer → detect changes → sample → analyze with AI → evaluate rules → dispatch alerts.',
    stats:[['Pattern','1 task per camera'],['Backoff','5s→300s on failure'],['Health','ok / degraded / offline'],['Idle cost','$0']]},
  api:{icon:'&#127760;',title:'Vision REST API',file:'vision_api.py',
    desc:'aiohttp web server with 18+ endpoints. Serves the dashboard, MJPEG stream, scene data, rules CRUD, camera management, push endpoints, and this factory view.',
    stats:[['Port','8090'],['Endpoints','18+'],['Auth','Bearer token (optional)'],['CORS','Open for LAN']]},
  mcp:{icon:'&#128642;',title:'MCP Server',file:'server.py + __main__.py',
    desc:'FastMCP server for AI tools. Claude, Cursor, VS Code, Gemini connect here. Tools: get_camera_frame, get_scene_analysis, watch_for, check_alerts, manage_memory.',
    stats:[['Port','8400'],['Transport','streamable-http'],['Clients','Claude, Cursor, VS Code, Gemini']]},
  detector:{icon:'&#128065;',title:'ChangeDetector',file:'perception/change_detector.py',
    desc:'Detects visual changes between frames using perceptual hashing + pixel difference. No ML needed, runs in <5ms. Prevents unnecessary LLM calls when nothing changes.',
    stats:[['Speed','<5ms'],['Method','pHash + pixel diff'],['Levels','none / minor / moderate / major']]},
  sampler:{icon:'&#9201;',title:'FrameSampler',file:'perception/frame_sampler.py',
    desc:'The COST GATE. Decides WHEN to call the expensive LLM vision API. Major change = immediate. Moderate = debounce 3s. No rules = zero calls. Saves money.',
    stats:[['Debounce','3s'],['Cooldown','10s'],['Idle cost','$0/hr']]},
  analyzer:{icon:'&#129504;',title:'FrameAnalyzer',file:'reasoning/analyzer.py (219 lines)',
    desc:'Encodes frame to base64 JPEG, builds a context prompt, calls the LLM vision API, parses structured JSON response. The "eyes" of the system.',
    stats:[['Input','JPEG frame + context'],['Output','Structured JSON'],['Providers','Gemini, Claude, OpenAI'],['Quality','60% JPEG compression']]},
  scene:{icon:'&#127916;',title:'SceneState',file:'perception/scene_state.py',
    desc:'Rolling memory of what the camera sees. Tracks: summary text, objects present, people count, change log (last 200 events). Persists across analysis cycles.',
    stats:[['Fields','summary, objects, people_count'],['Change log','200 entries max'],['Updated','After each LLM analysis']]},
  engine:{icon:'&#9878;&#65039;',title:'RulesEngine',file:'rules/engine.py',
    desc:'Evaluates watch rules against AI analysis results. Example: "alert me if a person is at the door" → checks LLM output → fires alert with confidence score.',
    stats:[['Method','Condition matching on LLM output'],['Cooldown','60s per rule'],['Output','AlertEvent']]},
  templates:{icon:'&#128203;',title:'Rule Templates',file:'rules/templates.py (193 lines)',
    desc:'9 pre-built rule templates: person detection, package delivery, pet activity, parking, pantry inventory, baby monitor, workspace, weather, storefront.',
    stats:[['Count','9 presets'],['Categories','Security, Home, Work, Retail'],['Custom','User-defined via /watch']]},
  store:{icon:'&#128190;',title:'RulesStore',file:'rules/store.py',
    desc:'YAML-based rule persistence. CRUD operations with atomic file writes.',
    stats:[['Format','YAML'],['Path','~/.physical-mcp/rules.yaml']]},
  tgbot:{icon:'&#128172;',title:'Telegram Bot',file:'bot/telegram_bot.py',
    desc:'NEW: Bidirectional Telegram chat. Users message the bot to interact with their cameras. Commands: /snap (photo), /scene (describe), /watch (create rule), /rules (list), /setup (pair camera). Free text questions get AI answers about what the camera sees.',
    stats:[['/snap','Take a photo right now'],['/scene','Describe what you see'],['/watch','Create alert rule'],['/setup','Pair camera (claim code)'],['Free text','Ask anything about the scene'],['Alerts','Auto-sent with photo']]},
  whatsapp:{icon:'&#128242;',title:'WhatsApp',file:'OpenClaw channel (Baileys)',
    desc:'Chat with your camera on WhatsApp via OpenClaw. Same commands as Telegram. Uses Baileys library for WhatsApp Web protocol.',
    stats:[['Protocol','WhatsApp Web (Baileys)'],['Via','OpenClaw'],['Setup','Scan QR code once']]},
  'discord-ch':{icon:'&#127918;',title:'Discord',file:'OpenClaw channel',
    desc:'Chat with your camera on Discord via OpenClaw bot. Same commands as Telegram.',
    stats:[['Via','OpenClaw bot'],['Setup','Add bot to server']]},
  'slack-ch':{icon:'&#128188;',title:'Slack',file:'OpenClaw channel',
    desc:'Chat with your camera on Slack via OpenClaw. Same commands as Telegram.',
    stats:[['Via','OpenClaw (Socket Mode)'],['Setup','Install Slack app']]},
  signal:{icon:'&#128274;',title:'Signal',file:'OpenClaw channel (signal-cli)',
    desc:'Most private option. Chat with your camera on Signal via OpenClaw. End-to-end encrypted.',
    stats:[['Protocol','Signal (signal-cli)'],['Via','OpenClaw'],['Privacy','E2E encrypted']]},
  dispatch:{icon:'&#128236;',title:'Alert Dispatcher',file:'notifications/__init__.py',
    desc:'Routes AlertEvents to the appropriate delivery channel (Telegram photo, Discord embed, Slack Block Kit, etc). Desktop popup added as bonus.',
    stats:[['Channels','7+ (Telegram, Discord, Slack, ntfy, desktop, webhook, OpenClaw)'],['Routing','By notification.type']]}
};

// ═══════════════════════════════════════════════════════════
// BELT CONNECTIONS [fromId, toId, label, description]
// ═══════════════════════════════════════════════════════════
const BELTS = [
  // Cameras → Relay
  ['n-yoosee','n-relay','RTSP','Yoosee camera streams RTSP video to relay agent'],
  ['n-ipcam','n-relay','RTSP','IP camera streams RTSP to relay'],
  ['n-phone','n-relay','MJPEG','Phone camera streams MJPEG to relay'],
  // USB direct to cloud server (no relay needed for local)
  ['n-usb','n-buffer','frames','USB camera feeds directly into buffer (local mode)'],
  // Relay → Cloud
  ['n-relay','n-push','HTTPS POST','Relay pushes JPEG frames to cloud over HTTPS'],
  ['n-provision','n-pair','credentials','WiFi creds + claim code from captive portal'],
  ['n-pair','n-push','register','Claim code creates cloud camera via POST /push/register'],
  // Cloud internal
  ['n-push','n-cloud-cam','JPEG','Push endpoint feeds frames into CloudCamera'],
  ['n-cloud-cam','n-buffer','frames','Cloud camera provides frames to buffer'],
  ['n-buffer','n-loop','frames','Buffer feeds frames to perception loop'],
  ['n-loop','n-detector','frame','Loop sends frame for change detection'],
  ['n-detector','n-sampler','change level','Change level: none/minor/moderate/major'],
  ['n-sampler','n-analyzer','selected frame','Frames that pass the cost gate for LLM analysis'],
  ['n-analyzer','n-scene','JSON','Structured analysis: summary, objects, people, changes'],
  ['n-scene','n-engine','context','Scene state fed into rule evaluation'],
  ['n-store','n-engine','rules','Watch rules loaded from YAML persistence'],
  ['n-templates','n-store','presets','Template rules written to store'],
  // Rules → Chat
  ['n-engine','n-dispatch','alerts','Triggered AlertEvents with confidence scores'],
  ['n-dispatch','n-tgbot','alert','Alert with photo sent to Telegram chat'],
  ['n-dispatch','n-whatsapp','alert','Alert sent to WhatsApp'],
  ['n-dispatch','n-discord-ch','alert','Alert sent to Discord'],
  ['n-dispatch','n-slack-ch','alert','Alert sent to Slack'],
  ['n-dispatch','n-signal','alert','Alert sent to Signal'],
  // Telegram bot → scene (bidirectional chat)
  ['n-tgbot','n-scene','query','User asks about scene via free text'],
  // API/MCP connections
  ['n-loop','n-api','state','Loop exposes live data to REST API'],
  ['n-loop','n-mcp','state','Loop exposes live data to MCP tools'],
];

// ═══════════════════════════════════════════════════════════
// DRAG-TO-REARRANGE NODES
// ═══════════════════════════════════════════════════════════
let dragNode = null, dragOffX = 0, dragOffY = 0, hasDragged = false;
const defaultPositions = {};
document.querySelectorAll('.node').forEach(n => {
  defaultPositions[n.id] = { left: n.offsetLeft, top: n.offsetTop };
});

function loadLayout() {
  try {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (!saved) return;
    const layout = JSON.parse(saved);
    Object.entries(layout).forEach(([id, pos]) => {
      const el = document.getElementById(id);
      if (el) { el.style.left = pos.left + 'px'; el.style.top = pos.top + 'px'; }
    });
  } catch(e) {}
}
function saveLayout() {
  const layout = {};
  document.querySelectorAll('.node').forEach(n => { layout[n.id] = { left: n.offsetLeft, top: n.offsetTop }; });
  localStorage.setItem(STORAGE_KEY, JSON.stringify(layout));
}
function resetLayout() {
  Object.entries(defaultPositions).forEach(([id, pos]) => {
    const el = document.getElementById(id);
    if (el) { el.style.left = pos.left + 'px'; el.style.top = pos.top + 'px'; }
  });
  localStorage.removeItem(STORAGE_KEY);
  drawBelts(); drawMinimapNodes();
  showToast('info', 'Layout Reset', 'Positions restored.');
}

document.querySelectorAll('.node').forEach(n => {
  n.addEventListener('mousedown', e => {
    if (e.button !== 0) return;
    const startX = e.clientX, startY = e.clientY;
    hasDragged = false;
    function onMove(ev) {
      const dx = ev.clientX - startX, dy = ev.clientY - startY;
      if (!hasDragged && Math.abs(dx) + Math.abs(dy) < 5) return;
      if (!hasDragged) {
        hasDragged = true; dragNode = n; n.classList.add('dragging');
        dragOffX = startX / scale - n.offsetLeft - panX / scale;
        dragOffY = startY / scale - n.offsetTop - panY / scale;
      }
      n.style.left = Math.round((ev.clientX / scale) - dragOffX - (panX / scale)) + 'px';
      n.style.top = Math.round((ev.clientY / scale) - dragOffY - (panY / scale)) + 'px';
      drawBelts();
    }
    function onUp() {
      window.removeEventListener('mousemove', onMove);
      window.removeEventListener('mouseup', onUp);
      if (hasDragged) { n.classList.remove('dragging'); dragNode = null; saveLayout(); drawMinimapNodes(); }
    }
    window.addEventListener('mousemove', onMove);
    window.addEventListener('mouseup', onUp);
  });
});
loadLayout();

// ═══════════════════════════════════════════════════════════
// PARTICLE SYSTEM
// ═══════════════════════════════════════════════════════════
const particles = [];
const PARTICLE_SPEED = 0.008;
let beltPaths = [];
let serverActive = false;

function spawnParticle(beltIndex) {
  if (beltIndex >= beltPaths.length) return;
  particles.push({ belt:beltIndex, t:0, el:null });
}

function drawBelts() {
  const svg = document.getElementById('belts');
  svg.innerHTML = '';
  beltPaths = [];
  BELTS.forEach(([fid, tid, label, desc], idx) => {
    const f = document.getElementById(fid);
    const t = document.getElementById(tid);
    if (!f || !t) return;
    if (f.classList.contains('section-hidden') || t.classList.contains('section-hidden')) return;
    const fx = f.offsetLeft + f.offsetWidth;
    const fy = f.offsetTop + f.offsetHeight/2;
    const tx = t.offsetLeft;
    const ty = t.offsetTop + t.offsetHeight/2;
    const dx = tx - fx;
    let d;
    if (Math.abs(ty - fy) < 10) {
      d = `M${fx},${fy} L${tx},${ty}`;
    } else if (fx > tx) {
      const my = (fy+ty)/2;
      d = `M${fx},${fy} L${fx+25},${fy} L${fx+25},${my} L${tx-25},${my} L${tx-25},${ty} L${tx},${ty}`;
    } else {
      const mx = fx + dx*0.4;
      d = `M${fx},${fy} C${mx},${fy} ${fx+dx*0.6},${ty} ${tx},${ty}`;
    }
    const path = document.createElementNS('http://www.w3.org/2000/svg','path');
    path.setAttribute('d', d);
    path.classList.add('belt-path','flowing');
    path.dataset.idx = idx;
    path.style.pointerEvents = 'stroke';
    path.addEventListener('mouseenter', () => path.classList.add('belt-hover'));
    path.addEventListener('mouseleave', () => path.classList.remove('belt-hover'));
    path.addEventListener('click', e => { e.stopPropagation(); selectBelt(idx); });
    svg.appendChild(path);
    beltPaths.push(path);
    // Junction dot
    const dot = document.createElementNS('http://www.w3.org/2000/svg','circle');
    dot.setAttribute('cx', tx); dot.setAttribute('cy', ty); dot.setAttribute('r', '3.5');
    dot.classList.add('belt-junction');
    svg.appendChild(dot);
    // Label
    if (label) {
      const pathLen = path.getTotalLength();
      const mid = path.getPointAtLength(pathLen * 0.5);
      const textW = label.length * 5.5 + 8;
      const bg = document.createElementNS('http://www.w3.org/2000/svg','rect');
      bg.setAttribute('x', mid.x - textW/2); bg.setAttribute('y', mid.y - 7);
      bg.setAttribute('width', textW); bg.setAttribute('height', 14);
      bg.classList.add('belt-label-bg');
      svg.appendChild(bg);
      const text = document.createElementNS('http://www.w3.org/2000/svg','text');
      text.setAttribute('x', mid.x); text.setAttribute('y', mid.y);
      text.textContent = label; text.classList.add('belt-label');
      svg.appendChild(text);
    }
  });
}

function animateParticles() {
  const svg = document.getElementById('belts');
  for (let i = particles.length - 1; i >= 0; i--) {
    const p = particles[i];
    p.t += PARTICLE_SPEED;
    if (p.t >= 1) { if (p.el) p.el.remove(); particles.splice(i, 1); continue; }
    const path = beltPaths[p.belt];
    if (!path) { particles.splice(i, 1); continue; }
    const pt = path.getPointAtLength(p.t * path.getTotalLength());
    if (!p.el) {
      p.el = document.createElementNS('http://www.w3.org/2000/svg','circle');
      p.el.classList.add('data-particle'); p.el.setAttribute('r', '3');
      svg.appendChild(p.el);
    }
    p.el.setAttribute('cx', pt.x); p.el.setAttribute('cy', pt.y);
  }
  requestAnimationFrame(animateParticles);
}

function spawnLoop() {
  if (serverActive) {
    // Spawn particles on main data flow belts
    const activeBelts = [0,4,8,9,10,11,12,13,14,17,18];
    spawnParticle(activeBelts[Math.floor(Math.random()*activeBelts.length)]);
  }
  setTimeout(spawnLoop, 300 + Math.random()*700);
}

// ═══════════════════════════════════════════════════════════
// BELT SELECTION & HIGHLIGHTING
// ═══════════════════════════════════════════════════════════
let selectedBelt = -1;
function selectBelt(idx) {
  beltPaths.forEach(p => p.classList.remove('belt-selected'));
  if (selectedBelt === idx) { selectedBelt = -1; clearHighlights(); return; }
  selectedBelt = idx;
  if (beltPaths[idx]) beltPaths[idx].classList.add('belt-selected');
  clearHighlights();
  const belt = BELTS[idx];
  const fromEl = document.getElementById(belt[0]);
  const toEl = document.getElementById(belt[1]);
  if (fromEl) fromEl.classList.add('highlight');
  if (toEl) toEl.classList.add('highlight');
}

function highlightConnections(nodeId) {
  clearHighlights();
  const connected = new Set([nodeId]);
  BELTS.forEach(([from, to], idx) => {
    if (from === nodeId || to === nodeId) {
      connected.add(from); connected.add(to);
      if (beltPaths[idx]) beltPaths[idx].style.opacity = '1';
    }
  });
  document.querySelectorAll('.node').forEach(n => {
    if (!connected.has(n.id)) n.classList.add('dim-node');
    else n.classList.add('highlight');
  });
}

function isolatePipeline(nodeId) {
  clearHighlights();
  const visited = new Set(), queue = [nodeId], activeBeltsSet = new Set();
  while (queue.length) {
    const id = queue.shift();
    if (visited.has(id)) continue;
    visited.add(id);
    BELTS.forEach(([from, to], idx) => {
      if (from === id && !visited.has(to)) { queue.push(to); activeBeltsSet.add(idx); }
      if (to === id && !visited.has(from)) { queue.push(from); activeBeltsSet.add(idx); }
    });
  }
  document.querySelectorAll('.node').forEach(n => {
    if (!visited.has(n.id)) n.classList.add('dim-node');
    else n.classList.add('highlight');
  });
  beltPaths.forEach((p, i) => { p.style.opacity = activeBeltsSet.has(i) ? '1' : '0.1'; });
}

function clearHighlights() {
  document.querySelectorAll('.node').forEach(n => n.classList.remove('dim-node','highlight'));
  beltPaths.forEach(p => { p.style.opacity = ''; p.classList.remove('belt-selected'); });
  selectedBelt = -1;
}

// ═══════════════════════════════════════════════════════════
// PAN & ZOOM
// ═══════════════════════════════════════════════════════════
let scale = 0.55, panX = 40, panY = 30;
let dragging = false, dragStartX, dragStartY;
const factory = document.getElementById('factory');
const wrap = document.getElementById('canvas-wrap');

function applyTransform() {
  factory.style.transform = `translate(${panX}px,${panY}px) scale(${scale})`;
  document.getElementById('zoom-pct').textContent = Math.round(scale*100)+'%';
  updateMinimap();
}
applyTransform();

wrap.addEventListener('mousedown', e => {
  if (e.target.closest('.node') || e.target.closest('#detail')) return;
  dragging = true; wrap.classList.add('grabbing');
  dragStartX = e.clientX - panX; dragStartY = e.clientY - panY;
});
window.addEventListener('mousemove', e => {
  if (!dragging) return;
  panX = e.clientX - dragStartX; panY = e.clientY - dragStartY;
  applyTransform();
});
window.addEventListener('mouseup', () => { dragging=false; wrap.classList.remove('grabbing'); });
wrap.addEventListener('wheel', e => {
  e.preventDefault();
  const rect = wrap.getBoundingClientRect();
  const mx = e.clientX - rect.left, my = e.clientY - rect.top;
  const oldScale = scale;
  scale = Math.max(0.2, Math.min(2.5, scale + (e.deltaY > 0 ? -0.05 : 0.05)));
  panX = mx - (mx - panX) * (scale / oldScale);
  panY = my - (my - panY) * (scale / oldScale);
  applyTransform();
}, {passive:false});

function zoomIn() { scale = Math.min(2.5, scale+0.1); applyTransform(); }
function zoomOut() { scale = Math.max(0.2, scale-0.1); applyTransform(); }
function resetView() { scale=0.55; panX=40; panY=30; applyTransform(); }
function fitAll() {
  const vw = wrap.clientWidth, vh = wrap.clientHeight;
  scale = Math.min(vw/2600, vh/1000, 1.0);
  panX = (vw - 2600*scale)/2; panY = (vh - 1000*scale)/2;
  applyTransform();
}
function centerOnNode(nodeId) {
  const el = document.getElementById(nodeId);
  if (!el) return;
  panX = wrap.clientWidth/2 - (el.offsetLeft + el.offsetWidth/2)*scale;
  panY = wrap.clientHeight/2 - (el.offsetTop + el.offsetHeight/2)*scale;
  applyTransform();
}

// ═══════════════════════════════════════════════════════════
// SEARCH
// ═══════════════════════════════════════════════════════════
const searchInput = document.getElementById('search-input');
const searchResults = document.getElementById('search-results');

searchInput.addEventListener('input', () => {
  const q = searchInput.value.toLowerCase().trim();
  if (!q) { searchResults.classList.remove('show'); clearHighlights(); return; }
  const matches = [];
  Object.entries(META).forEach(([id, m]) => {
    if (`${m.title} ${m.file} ${m.desc}`.toLowerCase().includes(q)) matches.push({id, ...m});
  });
  if (!matches.length) { searchResults.classList.remove('show'); return; }
  searchResults.innerHTML = matches.map(m =>
    `<div class="search-item" data-id="${m.id}"><span class="si-icon">${m.icon}</span><span class="si-title">${m.title}</span><span class="si-file">${m.file.split(' ')[0]}</span></div>`
  ).join('');
  searchResults.classList.add('show');
  clearHighlights();
  const matchIds = new Set(matches.map(m => document.querySelector(`[data-id="${m.id}"]`)?.id).filter(Boolean));
  document.querySelectorAll('.node').forEach(n => {
    if (!matchIds.has(n.id)) n.classList.add('dim-node'); else n.classList.add('highlight');
  });
});
searchInput.addEventListener('blur', () => setTimeout(() => searchResults.classList.remove('show'), 200));
searchResults.addEventListener('click', e => {
  const item = e.target.closest('.search-item');
  if (!item) return;
  const nodeEl = document.querySelector(`[data-id="${item.dataset.id}"]`);
  if (nodeEl) { centerOnNode(nodeEl.id); openDetail(item.dataset.id); }
  searchInput.value = ''; searchResults.classList.remove('show'); clearHighlights();
});

// ═══════════════════════════════════════════════════════════
// COLLAPSIBLE SECTIONS
// ═══════════════════════════════════════════════════════════
const collapsedSections = new Set(JSON.parse(localStorage.getItem('factory-v2-collapsed') || '[]'));
function toggleSection(sectionName) {
  if (collapsedSections.has(sectionName)) collapsedSections.delete(sectionName);
  else collapsedSections.add(sectionName);
  localStorage.setItem('factory-v2-collapsed', JSON.stringify([...collapsedSections]));
  applySectionState(); drawBelts(); drawMinimapNodes();
}
function applySectionState() {
  document.querySelectorAll('.section-label').forEach(l => {
    l.classList.toggle('collapsed', collapsedSections.has(l.dataset.section));
  });
  document.querySelectorAll('.node').forEach(n => {
    const sec = n.dataset.section;
    if (sec && collapsedSections.has(sec)) n.classList.add('section-hidden');
    else n.classList.remove('section-hidden');
  });
}
document.querySelectorAll('.section-label').forEach(l => l.addEventListener('click', () => toggleSection(l.dataset.section)));
applySectionState();

// ═══════════════════════════════════════════════════════════
// MINI-MAP
// ═══════════════════════════════════════════════════════════
function updateMinimap() {
  const mmW=200, mmH=120, fW=2600, fH=1000;
  const vp = document.getElementById('minimap-vp');
  const vw = wrap.clientWidth/scale, vh = wrap.clientHeight/scale;
  const ox = -panX/scale, oy = -panY/scale;
  vp.style.left=(ox*mmW/fW)+'px'; vp.style.top=(oy*mmH/fH)+'px';
  vp.style.width=Math.min(vw*mmW/fW,mmW)+'px'; vp.style.height=Math.min(vh*mmH/fH,mmH)+'px';
}
function drawMinimapNodes() {
  const canvas = document.getElementById('minimap-canvas');
  const ctx = canvas.getContext('2d');
  canvas.width=200; canvas.height=120;
  const fW=2600, fH=1000, sx=200/fW, sy=120/fH;
  ctx.fillStyle='#0d1117'; ctx.fillRect(0,0,200,120);
  document.querySelectorAll('.node:not(.section-hidden)').forEach(n => {
    ctx.fillStyle = n.classList.contains('active') ? '#3fb950' : n.classList.contains('consumer') ? '#bc8cff' : n.classList.contains('chat-node') ? '#3fb950' : '#30363d';
    ctx.fillRect(n.offsetLeft*sx, n.offsetTop*sy, Math.max(n.offsetWidth*sx,3), Math.max(n.offsetHeight*sy,2));
  });
  ctx.strokeStyle='#e9456044'; ctx.lineWidth=0.5;
  BELTS.forEach(([fid,tid]) => {
    const f=document.getElementById(fid), t=document.getElementById(tid);
    if(!f||!t) return;
    ctx.beginPath();
    ctx.moveTo((f.offsetLeft+f.offsetWidth)*sx,(f.offsetTop+f.offsetHeight/2)*sy);
    ctx.lineTo(t.offsetLeft*sx,(t.offsetTop+t.offsetHeight/2)*sy);
    ctx.stroke();
  });
}
document.getElementById('minimap').addEventListener('click', e => {
  const rect=e.currentTarget.getBoundingClientRect();
  panX=wrap.clientWidth/2-(e.clientX-rect.left)/200*2600*scale;
  panY=wrap.clientHeight/2-(e.clientY-rect.top)/120*1000*scale;
  applyTransform();
});

// ═══════════════════════════════════════════════════════════
// DETAIL PANEL
// ═══════════════════════════════════════════════════════════
let activeNodeId = null;
function openDetail(id) {
  const m = META[id]; if (!m) return;
  activeNodeId = id;
  document.getElementById('detail-icon').innerHTML = m.icon||'';
  document.getElementById('detail-title').textContent = m.title;
  document.getElementById('detail-file').textContent = m.file;
  document.getElementById('detail-desc').innerHTML = m.desc;
  document.getElementById('detail-stats').innerHTML = m.stats.map(([k,v])=>`<li>${k}<span class="val">${v}</span></li>`).join('');
  // Connections
  const nodeEl = document.querySelector(`[data-id="${id}"]`);
  const nodeHtmlId = nodeEl?.id || '';
  const upstream = [], downstream = [];
  BELTS.forEach(([from, to, lbl, desc]) => {
    if (to === nodeHtmlId) upstream.push({id:from, title:document.getElementById(from)?.querySelector('.node-title')?.textContent||from, label:lbl});
    if (from === nodeHtmlId) downstream.push({id:to, title:document.getElementById(to)?.querySelector('.node-title')?.textContent||to, label:lbl});
  });
  let connHtml = '';
  if (upstream.length) {
    connHtml += '<div class="detail-section">UPSTREAM INPUTS</div>';
    connHtml += upstream.map(c => `<div class="live-item" onclick="openDetail(document.getElementById('${c.id}')?.dataset?.id)"><span class="lk">&#8592; ${c.title}</span><span class="lv">${c.label||'data'}</span></div>`).join('');
  }
  if (downstream.length) {
    connHtml += '<div class="detail-section">DOWNSTREAM OUTPUTS</div>';
    connHtml += downstream.map(c => `<div class="live-item" onclick="openDetail(document.getElementById('${c.id}')?.dataset?.id)"><span class="lk">${c.title} &#8594;</span><span class="lv">${c.label||'data'}</span></div>`).join('');
  }
  document.getElementById('detail-live').innerHTML = connHtml;
  // Actions
  const actions = document.getElementById('detail-actions');
  actions.innerHTML = '';
  ['Highlight Connections','Isolate Pipeline','Center'].forEach((label,i) => {
    const btn = document.createElement('button');
    btn.className='detail-btn'; btn.textContent=label;
    btn.onclick = () => { const el=document.querySelector(`[data-id="${id}"]`); if(!el) return; if(i===0) highlightConnections(el.id); if(i===1) isolatePipeline(el.id); if(i===2) centerOnNode(el.id); };
    actions.appendChild(btn);
  });
  document.querySelectorAll('.node').forEach(n => n.classList.remove('selected'));
  if (nodeEl) nodeEl.classList.add('selected');
  document.getElementById('detail').classList.add('open');
}
function closeDetail() {
  document.getElementById('detail').classList.remove('open');
  document.querySelectorAll('.node').forEach(n => n.classList.remove('selected'));
  activeNodeId = null;
}
document.querySelectorAll('.node').forEach(n => {
  n.addEventListener('click', e => { if (hasDragged) return; e.stopPropagation(); openDetail(n.dataset.id); });
});
wrap.addEventListener('click', e => { if (!e.target.closest('.node') && !e.target.closest('path')) clearHighlights(); });

// ═══════════════════════════════════════════════════════════
// TOAST + HELP + KEYBOARD
// ═══════════════════════════════════════════════════════════
function showToast(type, title, msg, duration=4000) {
  const c = document.getElementById('toast-container');
  const icons = {alert:'&#9888;&#65039;',info:'&#8505;&#65039;',success:'&#9989;'};
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  t.innerHTML = `<span class="toast-icon">${icons[type]||''}</span><div class="toast-body"><div class="toast-title">${title}</div><div class="toast-msg">${msg}</div></div><button class="toast-close" onclick="this.parentElement.remove()">&times;</button>`;
  c.appendChild(t);
  setTimeout(() => { t.style.animation='toast-out 0.3s ease forwards'; setTimeout(()=>t.remove(),300); }, duration);
}
function clearFeed() { document.getElementById('feed-items').innerHTML = '<div class="feed-item"><span class="feed-text" style="color:var(--dim);">Cleared</span></div>'; }
function toggleHelp() { document.getElementById('help-overlay').classList.toggle('show'); }

window.addEventListener('keydown', e => {
  if (e.target.tagName === 'INPUT') {
    if (e.key === 'Escape') { e.target.blur(); searchInput.value=''; searchResults.classList.remove('show'); clearHighlights(); }
    if ((e.ctrlKey||e.metaKey) && e.key==='k') { e.preventDefault(); searchInput.focus(); }
    return;
  }
  if (e.key === 'Escape') { closeDetail(); clearHighlights(); document.getElementById('help-overlay').classList.remove('show'); }
  if (e.key === '+' || e.key === '=') { zoomIn(); e.preventDefault(); }
  if (e.key === '-' || e.key === '_') { zoomOut(); e.preventDefault(); }
  if (e.key === 'Home') { resetView(); e.preventDefault(); }
  if (e.key === 'f' || e.key === 'F') { fitAll(); e.preventDefault(); }
  if (e.key === 'r' || e.key === 'R') { resetLayout(); e.preventDefault(); }
  if (e.key === '?') { toggleHelp(); e.preventDefault(); }
  if ((e.ctrlKey||e.metaKey) && e.key==='k') { e.preventDefault(); searchInput.focus(); }
  if ((e.key === 'h' || e.key === 'H') && activeNodeId) {
    const el = document.querySelector(`[data-id="${activeNodeId}"]`);
    if (el) highlightConnections(el.id);
  }
});

// ═══════════════════════════════════════════════════════════
// LIVE DATA POLLING
// ═══════════════════════════════════════════════════════════
let lastScene = '', lastAlertCount = 0;

async function api(path) {
  try { const r = await fetch(BASE+path, {headers:H}); if(!r.ok) return null; return await r.json(); } catch(e) { return null; }
}

function setStatus(id, state) {
  const el = document.getElementById(id);
  if (el) el.className = 'node-status-dot ' + state;
}

async function refresh() {
  const [health, rules, alerts, scene] = await Promise.all([
    api('/health'), api('/rules'), api('/alerts'), api('/scene')
  ]);

  if (health) {
    const camIds = Object.keys(health);
    const cams = camIds.length;
    document.getElementById('hud-cams').textContent = cams;
    serverActive = cams > 0;
    const dot = document.getElementById('hud-health-dot');
    dot.className = cams > 0 ? 'hud-dot' : 'hud-dot off';
    if (cams > 0) {
      setStatus('status-loop', 'online');
      setStatus('status-api', 'online');
      document.getElementById('n-loop').querySelector('.node-badge').textContent = 'RUNNING';
      // Check if any cloud cameras
      camIds.forEach(cid => {
        if (cid.startsWith('cloud:')) { setStatus('status-push', 'online'); document.getElementById('n-push')?.classList.add('active'); }
        else { setStatus('status-usb', 'online'); document.getElementById('n-usb')?.classList.add('active'); }
      });
    }
  }

  if (rules) {
    const list = Array.isArray(rules) ? rules : (rules.rules||[]);
    document.getElementById('hud-rules').textContent = list.length;
    if (list.length > 0) { setStatus('status-engine', 'online'); document.getElementById('n-engine')?.classList.add('active'); }
  }

  if (alerts) {
    const list = Array.isArray(alerts) ? alerts : (alerts.alerts||[]);
    document.getElementById('hud-alerts').textContent = list.length;
    if (list.length > lastAlertCount) {
      list.slice(0, list.length - lastAlertCount).forEach(a => {
        showToast('alert', a.rule_name || 'Alert', a.reasoning || 'Rule triggered', 6000);
        // Spawn particles on alert path
        [17,18,19,20,21].forEach(i => { if(Math.random()>0.4) spawnParticle(i); });
      });
    }
    lastAlertCount = list.length;
  }

  if (scene) {
    let sceneText = '';
    if (typeof scene === 'object' && !Array.isArray(scene)) {
      const keys = Object.keys(scene);
      if (keys.length) { const first = scene[keys[0]]; sceneText = first?.summary || first?.scene_summary || ''; }
    }
    if (sceneText && sceneText !== lastScene) {
      lastScene = sceneText;
      setStatus('status-analyzer', 'processing');
      setTimeout(() => setStatus('status-analyzer', 'online'), 2000);
      const feed = document.getElementById('feed-items');
      const item = document.createElement('div');
      item.className = 'feed-item';
      item.innerHTML = `<span class="feed-time">${new Date().toLocaleTimeString()}</span> <span class="feed-text">${sceneText.slice(0,120)}</span>`;
      feed.insertBefore(item, feed.firstChild);
      while (feed.children.length > 20) feed.removeChild(feed.lastChild);
      // Spawn particles on analysis path
      [9,10,11,12,13].forEach((b,i) => setTimeout(()=>spawnParticle(b), i*150));
    }
  }

  document.getElementById('hud-fps').textContent = serverActive ? '~2' : '0';
  setStatus('status-api', 'online');
  setStatus('status-mcp', 'online');
}

// ═══════════════════════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════════════════════
drawBelts();
drawMinimapNodes();
animateParticles();
spawnLoop();
refresh();
setInterval(refresh, 3000);
setInterval(drawMinimapNodes, 5000);
</script>
</body>
</html>
